<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connect Four</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@700;800&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --cream: #f5f0e8;
  --ink: #111108;
  --red: #e8321a;
  --yellow: #f5c400;
  --red-dim: #e8321a44;
  --yellow-dim: #f5c40033;
  --mid: #8a8070;
  --panel: #1a1910;
  --border: #2e2c20;
  --radius: 4px;
}

html, body {
  height: 100%;
  background: var(--ink);
  color: var(--cream);
  font-family: 'DM Mono', monospace;
  overflow: hidden;
}

/* ── GRAIN OVERLAY ── */
body::after {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  background-size: 200px;
  pointer-events: none;
  z-index: 9999;
  opacity: 0.6;
}

/* ── LAYOUT ── */
.app {
  display: grid;
  grid-template-columns: 220px 1fr 220px;
  grid-template-rows: 56px 1fr;
  height: 100vh;
  gap: 0;
}

/* ── HEADER ── */
header {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  border-bottom: 1px solid var(--border);
  background: var(--panel);
}

.logo {
  font-family: 'Bebas Neue', cursive;
  font-size: 1.6rem;
  letter-spacing: 0.12em;
  color: var(--cream);
}

.logo span { color: var(--red); }

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.settings-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--mid);
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  letter-spacing: 0.12em;
  padding: 6px 12px;
  cursor: pointer;
  transition: all 0.15s;
  border-radius: var(--radius);
}
.settings-btn:hover { border-color: var(--mid); color: var(--cream); }

/* ── LEFT PANEL ── */
.left-panel {
  grid-row: 2;
  border-right: 1px solid var(--border);
  background: var(--panel);
  padding: 24px 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.player-card {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.player-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
}

.player-card.you::before { background: var(--red); }
.player-card.ai::before { background: var(--yellow); }

.player-card.active {
  border-color: #3a3820;
  background: #1e1d12;
}

.player-card.active.you { box-shadow: 0 0 0 1px var(--red-dim); }
.player-card.active.ai { box-shadow: 0 0 0 1px var(--yellow-dim); }

.player-label {
  font-size: 0.62rem;
  letter-spacing: 0.22em;
  color: var(--mid);
  text-transform: uppercase;
  margin-bottom: 4px;
}

.player-name {
  font-family: 'Syne', sans-serif;
  font-size: 1.1rem;
  font-weight: 800;
  margin-bottom: 12px;
}

.you .player-name { color: var(--red); }
.ai .player-name { color: var(--yellow); }

.player-score {
  font-family: 'Bebas Neue', cursive;
  font-size: 3rem;
  line-height: 1;
  letter-spacing: 0.05em;
}

.turn-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.62rem;
  letter-spacing: 0.15em;
  color: var(--mid);
  margin-top: 8px;
  opacity: 0;
  transition: opacity 0.2s;
}

.player-card.active .turn-indicator { opacity: 1; }

.turn-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  animation: blink 1s ease-in-out infinite;
}

.you .turn-dot { background: var(--red); }
.ai .turn-dot { background: var(--yellow); }

@keyframes blink {
  0%, 100% { opacity: 1; } 50% { opacity: 0.2; }
}

/* Powerup status in left panel */
.powerup-status {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  display: none;
}

.powerup-status.visible { display: block; }

.powerup-label {
  font-size: 0.62rem;
  letter-spacing: 0.22em;
  color: var(--mid);
  text-transform: uppercase;
  margin-bottom: 8px;
}

.powerup-charges {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.charge-pip {
  width: 18px; height: 18px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--ink);
  position: relative;
  transition: all 0.3s;
}

.charge-pip.ready {
  background: var(--red);
  border-color: var(--red);
  box-shadow: 0 0 8px var(--red-dim);
}

.use-powerup-btn {
  width: 100%;
  background: var(--red);
  color: var(--cream);
  border: none;
  font-family: 'DM Mono', monospace;
  font-size: 0.68rem;
  font-weight: 500;
  letter-spacing: 0.15em;
  padding: 8px;
  cursor: pointer;
  border-radius: var(--radius);
  transition: all 0.15s;
  text-transform: uppercase;
}

.use-powerup-btn:hover { filter: brightness(1.15); }
.use-powerup-btn:disabled {
  background: var(--border);
  color: var(--mid);
  cursor: not-allowed;
  filter: none;
}

/* Active powerup banner */
.active-powerup-banner {
  background: #1e1a00;
  border: 1px solid var(--yellow);
  border-radius: var(--radius);
  padding: 10px 14px;
  display: none;
  animation: pulse-border 1s ease-in-out infinite;
}

.active-powerup-banner.on { display: block; }

@keyframes pulse-border {
  0%, 100% { border-color: var(--yellow); box-shadow: 0 0 0 0 var(--yellow-dim); }
  50% { border-color: #f5c400aa; box-shadow: 0 0 12px 2px var(--yellow-dim); }
}

.apb-label {
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  color: var(--yellow);
  text-transform: uppercase;
}

.apb-turns {
  font-family: 'Bebas Neue', cursive;
  font-size: 1.6rem;
  color: var(--yellow);
  line-height: 1.1;
}

/* ── CENTER ── */
.center {
  grid-row: 2;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  position: relative;
}

/* Column drop arrows */
.col-arrows {
  display: grid;
  grid-template-columns: repeat(7, 60px);
  gap: 5px;
}

.col-arrow {
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.15s;
  color: var(--red);
  font-size: 0.7rem;
}

.col-arrow.blocked { color: #444; cursor: not-allowed; opacity: 0.3 !important; }
.cell.blocked-col { cursor: not-allowed; }
.cell.blocked-col:hover { background: #110a0a; }

/* Board */
.board-outer {
  background: #0d0d08;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px;
  position: relative;
  box-shadow: 0 24px 64px #00000088;
}

.board-grid {
  display: grid;
  grid-template-columns: repeat(7, 60px);
  grid-template-rows: repeat(6, 60px);
  gap: 5px;
}

.cell {
  width: 60px; height: 60px;
  border-radius: 50%;
  background: var(--ink);
  border: 1px solid #1c1b12;
  cursor: pointer;
  transition: background 0.12s, border-color 0.12s;
  position: relative;
  overflow: hidden;
}

/* inner gloss */
.cell::after {
  content: '';
  position: absolute;
  top: 8%; left: 12%;
  width: 38%; height: 28%;
  background: radial-gradient(ellipse, rgba(255,255,255,0.12), transparent);
  border-radius: 50%;
  transform: rotate(-25deg);
  pointer-events: none;
}

.cell:hover { background: #1a1910; border-color: #2e2c20; }

.cell.p1 {
  background: radial-gradient(circle at 38% 32%, #ff6040, var(--red), #7a1208);
  border-color: var(--red);
  box-shadow: 0 0 14px #e8321a55, inset 0 -3px 6px #00000050;
  cursor: default;
}

.cell.p2 {
  background: radial-gradient(circle at 38% 32%, #ffe060, var(--yellow), #7a6000);
  border-color: var(--yellow);
  box-shadow: 0 0 14px #f5c40055, inset 0 -3px 6px #00000050;
  cursor: default;
}

.cell.win {
  animation: win-flash 0.55s ease-in-out infinite alternate;
}

@keyframes win-flash {
  from { filter: brightness(1) saturate(1); transform: scale(1); }
  to   { filter: brightness(1.5) saturate(1.3); transform: scale(1.1); }
}

.cell.drop {
  animation: piece-drop 0.32s cubic-bezier(0.22, 1, 0.36, 1);
}

@keyframes piece-drop {
  from { transform: translateY(-380px); }
  to   { transform: translateY(0); }
}

/* ── POWERUP FLASH OVERLAY ── */
.powerup-flash {
  position: absolute;
  inset: 0;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  opacity: 0;
  z-index: 50;
  background: rgba(245,196,0,0.06);
}

.powerup-flash.show {
  animation: flash-in-out 2.2s ease forwards;
}

@keyframes flash-in-out {
  0%   { opacity: 0; }
  8%   { opacity: 1; }
  80%  { opacity: 1; }
  100% { opacity: 0; }
}

.powerup-flash-text {
  font-family: 'Bebas Neue', cursive;
  font-size: clamp(2rem, 6vw, 3.5rem);
  letter-spacing: 0.18em;
  color: var(--yellow);
  text-shadow: 0 0 30px var(--yellow), 0 0 60px #f5c40066;
  animation: glitch-text 2.2s ease forwards;
  white-space: nowrap;
}

@keyframes glitch-text {
  0%   { transform: scale(0.6) skewX(-8deg); opacity: 0; }
  8%   { transform: scale(1.08) skewX(2deg); opacity: 1; }
  12%  { transform: scale(1) skewX(-1deg) translateX(-3px); }
  14%  { transform: scale(1) skewX(0deg) translateX(3px); }
  16%  { transform: scale(1) translateX(0); }
  85%  { transform: scale(1); opacity: 1; }
  100% { transform: scale(1.1); opacity: 0; }
}

/* Scanline effect on flash */
.powerup-flash::before {
  content: '';
  position: absolute; inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 3px,
    rgba(245,196,0,0.04) 3px,
    rgba(245,196,0,0.04) 4px
  );
  border-radius: 8px;
  opacity: 0;
  animation: scanlines-show 2.2s ease forwards;
}

@keyframes scanlines-show {
  0%, 100% { opacity: 0; }
  8%, 80%  { opacity: 1; }
}

/* ── STATUS ── */
.status {
  font-size: 0.68rem;
  letter-spacing: 0.2em;
  color: var(--mid);
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 8px;
  height: 18px;
}

.status-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  background: var(--mid);
}

/* Thinking dots */
.thinking { display: inline-flex; gap: 3px; margin-left: 4px; }
.thinking i {
  width: 4px; height: 4px;
  border-radius: 50%;
  background: var(--yellow);
  font-style: normal;
  animation: blink 1.1s ease-in-out infinite;
}
.thinking i:nth-child(2) { animation-delay: 0.18s; }
.thinking i:nth-child(3) { animation-delay: 0.36s; }

/* ── RIGHT PANEL ── */
.right-panel {
  grid-row: 2;
  border-left: 1px solid var(--border);
  background: var(--panel);
  padding: 24px 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.panel-section-title {
  font-size: 0.58rem;
  letter-spacing: 0.25em;
  color: var(--mid);
  text-transform: uppercase;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}

/* Difficulty */
.diff-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.diff-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  border: 1px solid transparent;
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.15s;
  font-size: 0.72rem;
  letter-spacing: 0.1em;
  color: var(--mid);
}

.diff-option:hover { border-color: var(--border); color: var(--cream); }

.diff-option.active {
  border-color: var(--border);
  background: #1e1d12;
  color: var(--cream);
}

.diff-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  border: 1px solid currentColor;
  transition: all 0.15s;
}

.diff-option.active .diff-dot {
  background: var(--red);
  border-color: var(--red);
  box-shadow: 0 0 6px var(--red-dim);
}

/* Log */
.move-log {
  flex: 1;
  overflow-y: auto;
  scrollbar-width: none;
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.log-entry {
  font-size: 0.62rem;
  letter-spacing: 0.08em;
  color: var(--mid);
  padding: 3px 0;
  border-bottom: 1px solid #1a1910;
  display: flex;
  gap: 8px;
}

.log-entry .log-who { min-width: 30px; }
.log-entry.log-you .log-who { color: var(--red); }
.log-entry.log-ai .log-who { color: var(--yellow); }
.log-entry.log-system { color: #5a5040; font-style: italic; }

/* Controls */
.ctrl-btn {
  width: 100%;
  background: none;
  border: 1px solid var(--border);
  color: var(--mid);
  font-family: 'DM Mono', monospace;
  font-size: 0.68rem;
  letter-spacing: 0.15em;
  padding: 9px;
  cursor: pointer;
  border-radius: var(--radius);
  transition: all 0.15s;
  text-transform: uppercase;
}

.ctrl-btn:hover { border-color: var(--mid); color: var(--cream); }
.ctrl-btn.primary {
  background: var(--red);
  border-color: var(--red);
  color: var(--cream);
}
.ctrl-btn.primary:hover { filter: brightness(1.12); }

/* ── SETTINGS MODAL ── */
.modal-bg {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}

.modal-bg.open { opacity: 1; pointer-events: all; }

.modal {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 32px;
  width: 340px;
  transform: translateY(12px);
  transition: transform 0.2s;
}

.modal-bg.open .modal { transform: translateY(0); }

.modal-title {
  font-family: 'Syne', sans-serif;
  font-size: 1.2rem;
  font-weight: 800;
  margin-bottom: 24px;
  color: var(--cream);
}

.modal-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 0;
  border-bottom: 1px solid var(--border);
}

.modal-row:last-of-type { border-bottom: none; }

.modal-row-label {
  font-size: 0.75rem;
  letter-spacing: 0.1em;
  color: var(--cream);
}

.modal-row-sub {
  font-size: 0.6rem;
  color: var(--mid);
  letter-spacing: 0.06em;
  margin-top: 2px;
}

/* Toggle switch */
.toggle {
  width: 40px; height: 22px;
  background: var(--border);
  border-radius: 11px;
  position: relative;
  cursor: pointer;
  transition: background 0.2s;
  flex-shrink: 0;
}

.toggle.on { background: var(--red); }

.toggle::after {
  content: '';
  position: absolute;
  top: 3px; left: 3px;
  width: 16px; height: 16px;
  background: var(--cream);
  border-radius: 50%;
  transition: transform 0.2s;
}

.toggle.on::after { transform: translateX(18px); }

.modal-close {
  width: 100%;
  margin-top: 24px;
  background: none;
  border: 1px solid var(--border);
  color: var(--mid);
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  letter-spacing: 0.15em;
  padding: 10px;
  cursor: pointer;
  border-radius: var(--radius);
  transition: all 0.15s;
  text-transform: uppercase;
}

.modal-close:hover { border-color: var(--mid); color: var(--cream); }

/* ── END OVERLAY ── */
.end-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.82);
  backdrop-filter: blur(12px);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.end-overlay.open { opacity: 1; pointer-events: all; }

.end-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 48px 56px;
  text-align: center;
  transform: scale(0.92);
  transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
}

.end-overlay.open .end-card { transform: scale(1); }

.end-result {
  font-family: 'Bebas Neue', cursive;
  font-size: 4rem;
  letter-spacing: 0.1em;
  line-height: 1;
  margin-bottom: 6px;
}

.end-result.win { color: var(--red); text-shadow: 0 0 40px var(--red-dim); }
.end-result.lose { color: var(--yellow); }
.end-result.draw { color: var(--mid); }

.end-sub {
  font-size: 0.68rem;
  letter-spacing: 0.2em;
  color: var(--mid);
  text-transform: uppercase;
  margin-bottom: 32px;
}

.end-btn {
  background: var(--red);
  border: none;
  color: var(--cream);
  font-family: 'DM Mono', monospace;
  font-size: 0.75rem;
  font-weight: 500;
  letter-spacing: 0.2em;
  padding: 12px 32px;
  cursor: pointer;
  border-radius: var(--radius);
  text-transform: uppercase;
  transition: filter 0.15s;
}

.end-btn:hover { filter: brightness(1.15); }
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <header>
    <div class="logo">Connect <span>Four</span></div>
    <div class="header-right">
      <button class="settings-btn" id="settings-btn">⚙ Settings</button>
    </div>
  </header>

  <!-- LEFT PANEL -->
  <div class="left-panel">
    <div class="player-card you active" id="card-you">
      <div class="player-label">Player</div>
      <div class="player-name">You</div>
      <div class="player-score" id="score-you">0</div>
      <div class="turn-indicator">
        <div class="turn-dot"></div>
        <span>Your move</span>
      </div>
    </div>

    <div class="player-card ai" id="card-ai">
      <div class="player-label">Opponent</div>
      <div class="player-name">Machine</div>
      <div class="player-score" id="score-ai">0</div>
      <div class="turn-indicator">
        <div class="turn-dot"></div>
        <span>Thinking...</span>
      </div>
    </div>

    <!-- Powerup status -->
    <div class="powerup-status" id="powerup-status">
      <div class="powerup-label">⚡ Double Turn</div>
      <div class="powerup-charges" id="charge-pips"></div>
      <button class="use-powerup-btn" id="use-powerup-btn" disabled>Activate</button>
    </div>

    <!-- Active powerup banner -->
    <div class="active-powerup-banner" id="active-banner">
      <div class="apb-label">⚡ Double Turn Active</div>
      <div class="apb-turns" id="banner-turns">2 moves left</div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center">
    <div class="col-arrows" id="col-arrows">
      <div class="col-arrow" data-col="0">▼</div>
      <div class="col-arrow" data-col="1">▼</div>
      <div class="col-arrow" data-col="2">▼</div>
      <div class="col-arrow" data-col="3">▼</div>
      <div class="col-arrow" data-col="4">▼</div>
      <div class="col-arrow" data-col="5">▼</div>
      <div class="col-arrow" data-col="6">▼</div>
    </div>

    <div class="board-outer" id="board-outer">
      <div class="board-grid" id="board"></div>
      <div class="powerup-flash" id="powerup-flash">
        <div class="powerup-flash-text">⚡ DOUBLE TURN ⚡</div>
      </div>
    </div>

    <div class="status" id="status">
      <div class="status-dot" id="status-dot"></div>
      <span id="status-text">Your turn</span>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">
    <div>
      <div class="panel-section-title">Difficulty</div>
      <div class="diff-group">
        <div class="diff-option" data-diff="easy">
          <div class="diff-dot"></div> Easy
        </div>
        <div class="diff-option active" data-diff="medium">
          <div class="diff-dot"></div> Medium
        </div>
        <div class="diff-option" data-diff="hard">
          <div class="diff-dot"></div> Hard
        </div>
        <div class="diff-option" data-diff="brutal">
          <div class="diff-dot"></div> Brutal
        </div>
      </div>
    </div>

    <div>
      <div class="panel-section-title">Move Log</div>
      <div class="move-log" id="move-log"></div>
    </div>

    <div style="display:flex;flex-direction:column;gap:8px;margin-top:auto">
      <button class="ctrl-btn primary" id="new-game-btn">New Game</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-bg" id="modal-bg">
  <div class="modal">
    <div class="modal-title">Settings</div>
    <div class="modal-row">
      <div>
        <div class="modal-row-label">Powerups</div>
        <div class="modal-row-sub">Double-turn when AI threatens a win</div>
      </div>
      <div class="toggle" id="powerup-toggle"></div>
    </div>
    <button class="modal-close" id="modal-close">Close</button>
  </div>
</div>

<!-- END OVERLAY -->
<div class="end-overlay" id="end-overlay">
  <div class="end-card">
    <div class="end-result" id="end-result"></div>
    <div class="end-sub" id="end-sub"></div>
    <button class="end-btn" id="end-btn">Play Again</button>
  </div>
</div>

<script>
// ─────────────────────────────────────────
//  CONSTANTS
// ─────────────────────────────────────────
const ROWS = 6, COLS = 7;
const HUMAN = 1, AI = 2;
const COL_ORDER = [3, 2, 4, 1, 5, 0, 6];

// Positional value table
const POS = (() => {
  const t = [];
  for (let r = 0; r < ROWS; r++) {
    t[r] = [];
    for (let c = 0; c < COLS; c++) {
      const cd = Math.abs(c - 3);
      const rd = Math.abs(r - 2.5);
      t[r][c] = Math.round((3 - cd) * 3 + (2.5 - rd) * 1.5);
    }
  }
  return t;
})();

// ─────────────────────────────────────────
//  STATE
// ─────────────────────────────────────────
let board = [];
let gameOver = false;
let currentTurn = HUMAN;
let scores = { human: 0, ai: 0 };
let difficulty = 'medium';
let moveCount = 0;

// Powerup state
let powerupsEnabled = false;
let powerupCharges = 0;
let powerupActive = false;
let powerupMovesLeft = 0;
let powerupBlockedCols = new Set();
let aiThreatsBlocked = 0;   // counts how many times we've given a powerup charge

// ─────────────────────────────────────────
//  DOM REFS
// ─────────────────────────────────────────
const boardEl     = document.getElementById('board');
const statusText  = document.getElementById('status-text');
const statusDot   = document.getElementById('status-dot');
const cardYou     = document.getElementById('card-you');
const cardAi      = document.getElementById('card-ai');
const moveLog     = document.getElementById('move-log');
const powerupStatus = document.getElementById('powerup-status');
const chargePips  = document.getElementById('charge-pips');
const usePuBtn    = document.getElementById('use-powerup-btn');
const activeBanner = document.getElementById('active-banner');
const bannerTurns = document.getElementById('banner-turns');
const flashEl     = document.getElementById('powerup-flash');
const endOverlay  = document.getElementById('end-overlay');
const endResult   = document.getElementById('end-result');
const endSub      = document.getElementById('end-sub');

// ─────────────────────────────────────────
//  BOARD LOGIC
// ─────────────────────────────────────────
function emptyBoard() {
  return Array.from({length: ROWS}, () => Array(COLS).fill(0));
}

function getRow(b, col) {
  for (let r = ROWS - 1; r >= 0; r--) if (b[r][col] === 0) return r;
  return -1;
}

function isValidCol(b, col) {
  return b[0][col] === 0;
}

function checkWin(b, player) {
  for (let r = 0; r < ROWS; r++)
    for (let c = 0; c <= COLS-4; c++)
      if (b[r][c]===player && b[r][c+1]===player && b[r][c+2]===player && b[r][c+3]===player)
        return [[r,c],[r,c+1],[r,c+2],[r,c+3]];
  for (let r = 0; r <= ROWS-4; r++)
    for (let c = 0; c < COLS; c++)
      if (b[r][c]===player && b[r+1][c]===player && b[r+2][c]===player && b[r+3][c]===player)
        return [[r,c],[r+1,c],[r+2,c],[r+3,c]];
  for (let r = 3; r < ROWS; r++)
    for (let c = 0; c <= COLS-4; c++)
      if (b[r][c]===player && b[r-1][c+1]===player && b[r-2][c+2]===player && b[r-3][c+3]===player)
        return [[r,c],[r-1,c+1],[r-2,c+2],[r-3,c+3]];
  for (let r = 0; r <= ROWS-4; r++)
    for (let c = 0; c <= COLS-4; c++)
      if (b[r][c]===player && b[r+1][c+1]===player && b[r+2][c+2]===player && b[r+3][c+3]===player)
        return [[r,c],[r+1,c+1],[r+2,c+2],[r+3,c+3]];
  return null;
}

function isDraw(b) {
  return b[0].every(v => v !== 0);
}

// ─────────────────────────────────────────
//  AI — HEURISTIC (main thread, non-blocking)
// ─────────────────────────────────────────

function scoreWindow(w, player) {
  const opp = player === AI ? HUMAN : AI;
  const pc = w.filter(x => x === player).length;
  const ec = w.filter(x => x === 0).length;
  const oc = w.filter(x => x === opp).length;
  if (oc > 0 && pc > 0) return 0;
  if (pc === 4) return 10000; if (pc === 3 && ec === 1) return 40; if (pc === 2 && ec === 2) return 8;
  if (oc === 4) return -10000; if (oc === 3 && ec === 1) return -120; if (oc === 2 && ec === 2) return -15;
  return 0;
}

function heuristic(b) {
  let s = 0;
  for (let r = 0; r < ROWS; r++)
    for (let c = 0; c < COLS; c++) {
      if (b[r][c] === AI) s += POS[r][c];
      if (b[r][c] === HUMAN) s -= POS[r][c];
    }
  for (let r = 0; r < ROWS; r++)
    for (let c = 0; c <= COLS - 4; c++)
      s += scoreWindow([b[r][c], b[r][c+1], b[r][c+2], b[r][c+3]], AI);
  for (let c = 0; c < COLS; c++)
    for (let r = 0; r <= ROWS - 4; r++)
      s += scoreWindow([b[r][c], b[r+1][c], b[r+2][c], b[r+3][c]], AI);
  for (let r = 3; r < ROWS; r++)
    for (let c = 0; c <= COLS - 4; c++)
      s += scoreWindow([b[r][c], b[r-1][c+1], b[r-2][c+2], b[r-3][c+3]], AI);
  for (let r = 0; r <= ROWS - 4; r++)
    for (let c = 0; c <= COLS - 4; c++)
      s += scoreWindow([b[r][c], b[r+1][c+1], b[r+2][c+2], b[r+3][c+3]], AI);
  return s;
}

function mmSync(b, depth, alpha, beta, maximizing) {
  if (checkWin(b, AI)) return 1e6 + depth;
  if (checkWin(b, HUMAN)) return -1e6 - depth;
  if (isDraw(b) || depth === 0) return heuristic(b);
  const cols = COL_ORDER.filter(c => b[0][c] === 0);
  if (maximizing) {
    let v = -Infinity;
    for (const col of cols) {
      const row = getRow(b, col); b[row][col] = AI;
      v = Math.max(v, mmSync(b, depth - 1, alpha, beta, false));
      b[row][col] = 0; alpha = Math.max(alpha, v);
      if (alpha >= beta) break;
    }
    return v;
  } else {
    let v = Infinity;
    for (const col of cols) {
      const row = getRow(b, col); b[row][col] = HUMAN;
      v = Math.min(v, mmSync(b, depth - 1, alpha, beta, true));
      b[row][col] = 0; beta = Math.min(beta, v);
      if (alpha >= beta) break;
    }
    return v;
  }
}

// Evaluate each top-level column in its own setTimeout tick so browser stays responsive
function getAIMoveAsync() {
  return new Promise(resolve => {
    const b = board.map(r => [...r]);
    const validCols = COL_ORDER.filter(c => b[0][c] === 0);

    // Instant win
    for (const col of validCols) {
      const row = getRow(b, col); b[row][col] = AI;
      if (checkWin(b, AI)) { b[row][col] = 0; return resolve(col); }
      b[row][col] = 0;
    }
    // Block human win
    for (const col of validCols) {
      const row = getRow(b, col); b[row][col] = HUMAN;
      if (checkWin(b, HUMAN)) { b[row][col] = 0; return resolve(col); }
      b[row][col] = 0;
    }
    // Opening
    if (b.flat().every(x => x === 0)) return resolve(3);

    const depths = { easy: 3, medium: 6, hard: 8, brutal: 8 };
    const depth = depths[difficulty] || 6;
    const timeBudget = { easy: 200, medium: 400, hard: 800, brutal: 1800 }[difficulty] || 400;
    const noise = difficulty === 'easy' ? () => (Math.random() - 0.5) * 30 : () => 0;

    // For brutal: use iterative deepening with a time budget
    // For others: evaluate each column in its own tick (keeps UI alive)
    if (difficulty === 'brutal') {
      // Run synchronously but with iterative deepening up to time limit
      const deadline = performance.now() + timeBudget;
      let bestCol = validCols[0];
      for (let d = 3; d <= 12; d++) {
        if (performance.now() > deadline) break;
        let best = -Infinity, col = validCols[0];
        for (const c of validCols) {
          const row = getRow(b, c); b[row][c] = AI;
          const score = mmSync(b, d - 1, -Infinity, Infinity, false);
          b[row][c] = 0;
          if (score > best) { best = score; col = c; }
          if (performance.now() > deadline) break;
        }
        bestCol = col;
      }
      return resolve(bestCol);
    }

    // Evaluate each column in its own tick (keeps UI alive)
    const scores = [];
    let idx = 0;

    function evalNext() {
      if (idx >= validCols.length) {
        // All done — pick best
        let best = scores[0];
        for (const s of scores) if (s.score > best.score) best = s;
        return resolve(best.col);
      }
      const col = validCols[idx++];
      const row = getRow(b, col);
      b[row][col] = AI;
      const score = mmSync(b, depth - 1, -Infinity, Infinity, false) + noise();
      b[row][col] = 0;
      scores.push({ col, score });
      setTimeout(evalNext, 0); // yield to browser between each column
    }
    evalNext();
  });
}

// ─────────────────────────────────────────
//  POWERUP LOGIC
// ─────────────────────────────────────────
function checkAIWinThreat() {
  // Returns true if AI has a 3-in-a-row that can win in one move
  const validCols = COL_ORDER.filter(c => isValidCol(board, c));
  for (const col of validCols) {
    const row = getRow(board, col);
    board[row][col] = AI;
    const w = checkWin(board, AI);
    board[row][col] = 0;
    if (w) return true;
  }
  return false;
}

function grantPowerup() {
  if (powerupCharges < 3) {
    powerupCharges++;
    renderCharges();
    addLog('system', '⚡ Powerup earned!');
  }
}

function renderCharges() {
  chargePips.innerHTML = '';
  for (let i = 0; i < 2; i++) {
    const pip = document.createElement('div');
    pip.className = 'charge-pip' + (i < powerupCharges ? ' ready' : '');
    chargePips.appendChild(pip);
  }
  usePuBtn.disabled = powerupCharges === 0 || powerupActive || currentTurn !== HUMAN;
}

function activatePowerup() {
  if (powerupCharges <= 0 || powerupActive) return;
  powerupCharges--;
  powerupActive = true;
  powerupMovesLeft = 2;
  renderCharges();
  updateActiveBanner();
  showPowerupFlash();
  addLog('system', '⚡ Double turn activated!');
}

function showPowerupFlash() {
  flashEl.classList.remove('show');
  void flashEl.offsetWidth; // reflow
  flashEl.classList.add('show');
  setTimeout(() => flashEl.classList.remove('show'), 2200);
}

function updateActiveBanner() {
  if (powerupsEnabled && powerupActive) {
    activeBanner.classList.add('on');
    bannerTurns.textContent = `${powerupMovesLeft} move${powerupMovesLeft !== 1 ? 's' : ''} left`;
  } else {
    activeBanner.classList.remove('on');
  }
}

// ─────────────────────────────────────────
//  RENDER
// ─────────────────────────────────────────
function renderBoard() {
  boardEl.innerHTML = '';
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      if (board[r][c] === HUMAN) cell.classList.add('p1');
      if (board[r][c] === AI)    cell.classList.add('p2');
      cell.dataset.col = c;
      boardEl.appendChild(cell);
    }
  }
}

function animateDrop(row, col, cls) {
  const cellEl = boardEl.children[row * COLS + col];
  cellEl.classList.add(cls, 'drop');
  cellEl.addEventListener('animationend', () => cellEl.classList.remove('drop'), {once: true});
}

function markWinCells(cells) {
  cells.forEach(([r, c]) => boardEl.children[r * COLS + c].classList.add('win'));
}

// ─────────────────────────────────────────
//  STATUS / LOG
// ─────────────────────────────────────────
function setStatus(text, color, thinking = false) {
  statusDot.style.background = color;
  let html = text;
  if (thinking) html += '<span class="thinking"><i></i><i></i><i></i></span>';
  statusText.innerHTML = html;
}

function setActiveTurn(who) {
  cardYou.classList.toggle('active', who === 'human');
  cardAi.classList.toggle('active', who === 'ai');
}

function addLog(who, msg) {
  const el = document.createElement('div');
  el.className = 'log-entry' + (who === 'you' ? ' log-you' : who === 'ai' ? ' log-ai' : ' log-system');
  el.innerHTML = `<span class="log-who">${who === 'you' ? 'YOU' : who === 'ai' ? 'AI' : '—'}</span><span>${msg}</span>`;
  moveLog.appendChild(el);
  moveLog.scrollTop = moveLog.scrollHeight;
}

// ─────────────────────────────────────────
//  GAME FLOW
// ─────────────────────────────────────────
function initGame() {
  board = emptyBoard();
  gameOver = false;
  currentTurn = HUMAN;
  moveCount = 0;
  powerupActive = false;
  powerupMovesLeft = 0;
  powerupCharges = powerupsEnabled ? 2 : 0;
  powerupBlockedCols = new Set();
  aiThreatsBlocked = 0;
  moveLog.innerHTML = '';
  renderBoard();
  renderCharges();
  updateActiveBanner();
  setStatus('Your turn', 'var(--red)');
  setActiveTurn('human');
  powerupStatus.classList.toggle('visible', powerupsEnabled);
  addLog('system', 'Game started.');
}

function endGame(type) {
  gameOver = true;
  if (type === 'win') {
    scores.human++;
    document.getElementById('score-you').textContent = scores.human;
    endResult.textContent = 'YOU WIN';
    endResult.className = 'end-result win';
    endSub.textContent = 'The machine has been defeated.';
    addLog('system', 'You win!');
  } else if (type === 'lose') {
    scores.ai++;
    document.getElementById('score-ai').textContent = scores.ai;
    endResult.textContent = 'MACHINE WINS';
    endResult.className = 'end-result lose';
    endSub.textContent = 'The machine outplayed you.';
    addLog('system', 'Machine wins.');
  } else {
    endResult.textContent = 'DRAW';
    endResult.className = 'end-result draw';
    endSub.textContent = 'An honourable standoff.';
    addLog('system', 'Draw.');
  }
  setTimeout(() => endOverlay.classList.add('open'), 400);
}

function humanMove(col) {
  if (gameOver || currentTurn !== HUMAN) return;
  if (!isValidCol(board, col)) return;

  // Second move of powerup: block any column that would complete four-in-a-row
  if (powerupActive && powerupsEnabled && powerupMovesLeft === 1 && powerupBlockedCols.has(col)) {
    setStatus('Can\'t win on double turn — pick elsewhere!', 'var(--red)');
    setTimeout(() => setStatus('Powerup — move again! (can\'t win)', 'var(--yellow)'), 1600);
    return;
  }

  const row = getRow(board, col);
  board[row][col] = HUMAN;
  moveCount++;
  animateDrop(row, col, 'p1');
  addLog('you', `col ${col + 1}`);

  const win = checkWin(board, HUMAN);
  if (win) {
    markWinCells(win);
    endGame('win');
    return;
  }
  if (isDraw(board)) { endGame('draw'); return; }

  // Handle powerup double-turn
  if (powerupActive && powerupsEnabled) {
    powerupMovesLeft--;
    updateActiveBanner();
    if (powerupMovesLeft > 0) {
      // Compute which columns would complete a win — block them for second move
      const blocked = new Set();
      for (let c = 0; c < COLS; c++) {
        if (!isValidCol(board, c)) continue;
        const r = getRow(board, c);
        board[r][c] = HUMAN;
        if (checkWin(board, HUMAN)) blocked.add(c);
        board[r][c] = 0;
      }
      powerupBlockedCols = blocked;
      setStatus('Powerup — move again! (can\'t win)', 'var(--yellow)');
      return;
    } else {
      powerupActive = false;
      powerupBlockedCols = new Set();
      updateActiveBanner();
      renderCharges();
    }
  }

  // AI turn
  currentTurn = AI;
  setStatus('Machine thinking', 'var(--yellow)', true);
  setActiveTurn('ai');

  // Small delay so status renders before worker starts
  setTimeout(async () => {
    if (gameOver) return;

    const aiCol = await getAIMoveAsync();
    if (gameOver) return; // player may have reset during think
    const aiRow = getRow(board, aiCol);
    board[aiRow][aiCol] = AI;
    animateDrop(aiRow, aiCol, 'p2');
    addLog('ai', `col ${aiCol + 1}`);

    const aiWin = checkWin(board, AI);
    if (aiWin) {
      markWinCells(aiWin);
      endGame('lose');
      return;
    }
    if (isDraw(board)) { endGame('draw'); return; }

    currentTurn = HUMAN;
    setStatus('Your turn', 'var(--red)');
    setActiveTurn('human');
    renderCharges();
  }, 80);
}

// ─────────────────────────────────────────
//  EVENTS
// ─────────────────────────────────────────

// Board clicks & hover
boardEl.addEventListener('click', e => {
  const col = parseInt(e.target.dataset.col);
  if (!isNaN(col)) humanMove(col);
});

boardEl.addEventListener('mousemove', e => {
  const col = e.target.dataset.col;
  document.querySelectorAll('.col-arrow').forEach(a => {
    a.classList.toggle('hover', a.dataset.col === col);
  });
});

boardEl.addEventListener('mouseleave', () => {
  document.querySelectorAll('.col-arrow').forEach(a => a.classList.remove('hover'));
});

document.getElementById('col-arrows').addEventListener('click', e => {
  const col = parseInt(e.target.dataset.col);
  if (!isNaN(col)) humanMove(col);
});

// Difficulty
document.querySelectorAll('.diff-option').forEach(opt => {
  opt.addEventListener('click', () => {
    document.querySelectorAll('.diff-option').forEach(o => o.classList.remove('active'));
    opt.classList.add('active');
    difficulty = opt.dataset.diff;
    initGame();
  });
});

// New game
document.getElementById('new-game-btn').addEventListener('click', () => {
  endOverlay.classList.remove('open');
  initGame();
});
document.getElementById('end-btn').addEventListener('click', () => {
  endOverlay.classList.remove('open');
  initGame();
});

// Powerup
usePuBtn.addEventListener('click', () => {
  if (currentTurn !== HUMAN || powerupCharges === 0 || powerupActive) return;
  activatePowerup();
});

// Settings
document.getElementById('settings-btn').addEventListener('click', () => {
  document.getElementById('modal-bg').classList.add('open');
});
document.getElementById('modal-close').addEventListener('click', () => {
  document.getElementById('modal-bg').classList.remove('open');
});
document.getElementById('modal-bg').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-bg'))
    document.getElementById('modal-bg').classList.remove('open');
});

const puToggle = document.getElementById('powerup-toggle');
puToggle.addEventListener('click', () => {
  powerupsEnabled = !powerupsEnabled;
  puToggle.classList.toggle('on', powerupsEnabled);
  powerupStatus.classList.toggle('visible', powerupsEnabled);
  if (powerupsEnabled) {
    powerupCharges = 2;
    renderCharges();
  } else {
    powerupActive = false;
    powerupMovesLeft = 0;
    powerupCharges = 0;
    updateActiveBanner();
    renderCharges();
  }
});

// ─────────────────────────────────────────
//  INIT
// ─────────────────────────────────────────
initGame();
</script>
</body>
</html>
